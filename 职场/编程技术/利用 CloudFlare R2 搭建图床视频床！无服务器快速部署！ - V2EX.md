---
link: https://www.v2ex.com/t/1098315
site: V2EX
date: 2024-12-17T21:33
excerpt: "åˆ†äº«å‘ç° - @740moe - æ”¯æŒ worker && pages éƒ¨ç½²ï¼ä½¿ç”¨ pages éƒ¨ç½²å¯ä»¥ fork
  ä»“åº“ï¼Œæˆ–è€…ä¸‹è½½_worker.js æ–‡ä»¶æ‰“åŒ…æˆå‹ç¼©æ–‡ä»¶ä¸Šä¼ ï¼# å…è´¹å¥—é¤ä»‹ç»- **å­˜å‚¨**: æ¯æœˆ"
twitter: https://twitter.com/@V2EX
slurped: 2025-02-08T10:47
title: åˆ©ç”¨ CloudFlare R2 æ­å»ºå›¾åºŠ/è§†é¢‘åºŠï¼æ— æœåŠ¡å™¨å¿«é€Ÿéƒ¨ç½²ï¼ - V2EX
---
  
Â  [740moe](/member/740moe) Â· 52 å¤©å‰ Â· 1270 æ¬¡ç‚¹å‡»

è¿™æ˜¯ä¸€ä¸ªåˆ›å»ºäº 52 å¤©å‰çš„ä¸»é¢˜ï¼Œå…¶ä¸­çš„ä¿¡æ¯å¯èƒ½å·²ç»æœ‰æ‰€å‘å±•æˆ–æ˜¯å‘ç”Ÿæ”¹å˜ã€‚

æ”¯æŒ worker && pages éƒ¨ç½²ï¼ä½¿ç”¨ pages éƒ¨ç½²å¯ä»¥ fork ä»“åº“ï¼Œæˆ–è€…ä¸‹è½½_worker.js æ–‡ä»¶æ‰“åŒ…æˆå‹ç¼©æ–‡ä»¶ä¸Šä¼ ï¼

# å…è´¹å¥—é¤ä»‹ç»

- **å­˜å‚¨**: æ¯æœˆ 10 GB
- **A ç±»æ“ä½œ**: æ¯æœˆ 100 ä¸‡æ¬¡è¯·æ±‚
- **B ç±»æ“ä½œ**: æ¯æœˆ 1000 ä¸‡æ¬¡è¯·æ±‚
- **å‡ºå£ï¼ˆæ•°æ®ä¼ è¾“åˆ°äº’è”ç½‘ï¼‰**: å…è´¹

ä¸ªäººä½¿ç”¨å®Œå…¨è¶³å¤Ÿï¼å›¾åºŠé»˜è®¤å¼€å¯å‹ç¼©ï¼Œå¯ä»¥å‚¨å­˜æ›´å¤šçš„å›¾ç‰‡æ–‡ä»¶ï¼

## åŠŸèƒ½ç‰¹ç‚¹

- æŸ¥çœ‹æœ¬åœ°å†å²è®°å½•
- å¯é€‰çš„è®¿å®¢éªŒè¯åŠŸèƒ½
- å•æ–‡ä»¶æœ€å¤§æ”¯æŒ 20MB
- æ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ å’Œç²˜è´´ä¸Šä¼ 
- æ”¯æŒæ‰¹é‡æ“ä½œå’Œæ˜¾ç¤ºä¸Šä¼ æ—¶é—´
- å›¾ç‰‡è‡ªåŠ¨å‹ç¼©ï¼ˆ GIF å’Œè§†é¢‘é™¤å¤–ï¼‰
- Cloudflare Cache API ç¼“å­˜æ”¯æŒ
- åŸºäº Cloudflare R2 çš„æ–‡ä»¶å­˜å‚¨
- æ”¯æŒå¤šç§é“¾æ¥æ ¼å¼ï¼ˆ URL ã€BBCode ã€Markdown ï¼‰
- æ”¯æŒå¸¸è§çš„å›¾ç‰‡å’Œè§†é¢‘æ ¼å¼ï¼ˆ jpg ã€png ã€gif ã€mp4 ï¼‰

## éƒ¨ç½²æ•™ç¨‹ï¼š

### 1. ç¯å¢ƒå˜é‡è¯´æ˜

éœ€è¦åœ¨ Cloudflare Workers ä¸­é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡:

|å˜é‡å|è¯´æ˜|å¿…å¡«|ç¤ºä¾‹|
|---|---|---|---|
|DOMAIN|è‡ªå®šä¹‰åŸŸå|æ˜¯|example.workers.dev|
|DATABASE|D1 æ•°æ®åº“ç»‘å®šå˜é‡åç§°|æ˜¯|DATABASE|
|USERNAME|ç®¡ç†å‘˜ç”¨æˆ·å|æ˜¯|admin|
|PASSWORD|ç®¡ç†å‘˜å¯†ç |æ˜¯|password123|
|ADMIN_PATH|ç®¡ç†åå°è·¯å¾„|æ˜¯|admin|
|ENABLE_AUTH|è®¿å®¢éªŒè¯ï¼ˆè®¾ç½®ä¸º true å¼€å¯ï¼Œä¸è®¾ç½®æˆ–è®¾ç½®ä¸º false åˆ™å…³é—­ï¼‰|å¦|false|
|R2_BUCKET|R2 å­˜å‚¨æ¡¶åç§°|æ˜¯|R2_BUCKET|

### 2. åˆ›å»º R2 å­˜å‚¨æ¡¶

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com)
2. è¿›å…¥ `R2 å¯¹è±¡å‚¨å­˜` â†’ `åˆ›å»ºå­˜å‚¨æ¡¶`
3. è®¾ç½®å­˜å‚¨æ¡¶åç§°å’ŒåŒºåŸŸ
4. ä¿å­˜å­˜å‚¨æ¡¶çš„åç§°ä»¥ä¾¿åç»­ä½¿ç”¨

### 3. åˆ›å»º D1 æ•°æ®åº“

1. ç™»å½• [Cloudflare Dashboard](https://dash.cloudflare.com)
2. è¿›å…¥ `Workers & Pages` â†’ `D1 SQL æ•°æ®åº“`
3. ç‚¹å‡» `åˆ›å»º` åˆ›å»ºæ•°æ®åº“
    - æ•°æ®åº“åç§°å¯è‡ªå®šä¹‰ï¼Œä¾‹å¦‚ `images`
    - å»ºè®®é€‰æ‹©æ•°æ®åº“ä½ç½®ä¸º `äºšå¤ªåœ°åŒº`ï¼Œå¯ä»¥è·å¾—æ›´å¥½çš„è®¿é—®é€Ÿåº¦
4. åˆ›å»ºæ•°æ®è¡¨:
    - ç‚¹å‡»æ•°æ®åº“åç§°è¿›å…¥è¯¦æƒ…é¡µ
    - é€‰æ‹© `æ§åˆ¶å°` æ ‡ç­¾
    - æ‰§è¡Œä»¥ä¸‹ SQL è¯­å¥:

```sql
CREATE TABLE media (
    url TEXT PRIMARY KEY
);
```

### 4. åˆ›å»º Worker

1. è¿›å…¥ `Workers & Pages`
2. ç‚¹å‡» `åˆ›å»º`
3. é€‰æ‹© `åˆ›å»º Worker`
4. ä¸º Worker è®¾ç½®ä¸€ä¸ªåç§°
5. ç‚¹å‡» `éƒ¨ç½²` åˆ›å»º Worker
6. ç‚¹å‡»ç»§ç»­å¤„ç†é¡¹ç›®

### 5. é…ç½®ç¯å¢ƒå˜é‡

1. åœ¨ Worker çš„ `è®¾ç½®` â†’ `å˜é‡å’Œæœºå¯†` ä¸­
2. ç‚¹å‡» `æ·»åŠ ` æ·»åŠ å˜é‡
3. ç‚¹å‡» `éƒ¨ç½²`

### 6. ç»‘å®šæ•°æ®åº“å’Œ R2 å‚¨å­˜

1. åœ¨ Worker è®¾ç½®é¡µé¢æ‰¾åˆ° `è®¾ç½®` â†’ `ç»‘å®š`
2. ç‚¹å‡» `æ·»åŠ `
3. é€‰æ‹© `D1 æ•°æ®åº“`
4. è®¾ç½®å˜é‡åä¸º `DATABASE`
5. é€‰æ‹©ä¹‹å‰åˆ›å»ºçš„æ•°æ®åº“
6. ç‚¹å‡» `éƒ¨ç½²`
7. é‡å¤ä¸Šè¿°æ­¥éª¤ç»‘å®š R2 å‚¨å­˜ï¼Œå˜é‡åä¸º `R2_BUCKET`

### 7. ç»‘å®šåŸŸå

1. åœ¨ Worker çš„ `è®¾ç½®` â†’ `åŸŸå’Œè·¯ç”±`
2. ç‚¹å‡» `æ·»åŠ ` â†’ `è‡ªå®šä¹‰åŸŸ`
3. è¾“å…¥ä½ åœ¨ Cloudflare ç»‘å®šçš„åŸŸå
4. ç‚¹å‡» `æ·»åŠ åŸŸ`
5. ç­‰å¾…åŸŸåç”Ÿæ•ˆ

### 8. éƒ¨ç½²ä»£ç 

1. è¿›å…¥ Worker çš„ç¼–è¾‘é¡µé¢
2. å°† `_worker.js` çš„å®Œæ•´ä»£ç å¤åˆ¶ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­
3. ç‚¹å‡» `éƒ¨ç½²`

### 9. é…ç½®ç¼“å­˜

1. è¿›å…¥ Cloudflare Dashboard
2. è¿›å…¥ `ç½‘ç«™` â†’ `é€‰æ‹©ä½ çš„è‡ªå®šä¹‰åŸŸå` â†’ `ç¼“å­˜` â†’ `Cache Rules` â†’ `åˆ›å»ºç¼“å­˜è§„åˆ™`
3. é€‰æ‹© `ç¼“å­˜æ‰€æœ‰å†…å®¹æ¨¡æ¿`
4. è®¾ç½® `è¾¹ç¼˜ TTL` â†’ `å¿½ç•¥ç¼“å­˜æ§åˆ¶æ ‡å¤´ï¼Œä½¿ç”¨æ­¤ TTL` â†’ `30 å¤©`ï¼ˆæ ¹æ®éœ€è¦è®¾ç½®ï¼‰
5. ç‚¹å‡» `éƒ¨ç½²`

æºç ï¼š [https://github.com/0-RTT/JSimages](https://github.com/0-RTT/JSimages)

æµ‹è¯•ï¼š ![image](https://baipiao.de/1734401106722.png)

![image](https://baipiao.de/1734438813282.png)

[

Cloudflare](/tag/Cloudflare)[

R2](/tag/R2)[

å›¾åºŠ](/tag/å›¾åºŠ)

9 æ¡å›å¤ Â **â€¢** Â 2024-12-19 23:48:21 +08:00

|   |   |   |
|---|---|---|
|![mayli](https://cdn.v2ex.com/gravatar/208dc525906db4a320e01914cc0f7af4?s=48&d=retro)||1<br><br>**[mayli](/member/mayli)** Â <br><br>Â  Â 52 å¤©å‰<br><br>åŸŸåä¸é”™|

|   |   |   |
|---|---|---|
|![hanguofu](https://cdn.v2ex.com/gravatar/108099cd4cea8dd2f44cffc10e0ae2b9?s=48&d=retro)||2<br><br>**[hanguofu](/member/hanguofu)** Â <br><br>Â  Â 52 å¤©å‰<br><br>è°¢è°¢åˆ†äº«ã€‚è¯·é—®åœ¨å“ªé‡Œå¯ä»¥è®¾ç½® è®¿é—®å›¾åºŠ/è§†é¢‘åºŠçš„é¢‘æ¬¡ ï¼Ÿ|

|   |   |   |
|---|---|---|
|![740moe](https://cdn.v2ex.com/gravatar/87debd9e71f45569cc3a756c22be6dc2?s=48&d=retro)||3<br><br>**[740moe](/member/740moe)** Â <br><br>OP<br><br>Â  Â 51 å¤©å‰<br><br>@[hanguofu](/member/hanguofu) cf çš„é˜²ç«å¢™é…ç½®è§„åˆ™ä¼°è®¡å¯ä»¥|

|                                                                                 |     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| ------------------------------------------------------------------------------- | --- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ![Lunrry](https://cdn.v2ex.com/avatar/f625/5dae/635681_normal.png?m=1730706709) |     | 4<br><br>**[Lunrry](/member/Lunrry)** Â <br><br>Â  Â 51 å¤©å‰<br><br>æŒ‰ç…§ä½ çš„æ­¥éª¤æ¥ï¼Œä¸Šä¼ å›¾ç‰‡æŠ¥é”™ï¼šR2 ä¸Šä¼ é”™è¯¯: TypeError: R2_BUCKET.put is not a function  <br>at handleUploadRequest (worker.js:881:21)  <br>at async Object.fetch (worker.js:20:44)  <br>at async jsonError (.internal-0c998967-bâ€¦e-facade-1.js:12:12)  <br>at async jsonError (.internal-0c998967-bâ€¦e-facade-1.js:12:12)  <br>at async jsonError (.internal-0c998967-bâ€¦e-facade-1.js:12:12)  <br>at async jsonError (.internal-0c998967-bâ€¦e-facade-1.js:12:12) |

|   |   |   |
|---|---|---|
|![740moe](https://cdn.v2ex.com/gravatar/87debd9e71f45569cc3a756c22be6dc2?s=48&d=retro)||5<br><br>**[740moe](/member/740moe)** Â <br><br>OP<br><br>Â  Â 51 å¤©å‰<br><br>@[Lunrry](/member/Lunrry) ä¼°è®¡å˜é‡æ²¡å¯¹ã€‚ç…§ç€ readme å¼„ä¸‹å§ã€‚æˆ‘æ›´æ–°äº†ä¸‹éƒ¨ç½²çš„æµç¨‹ã€‚[https://github.com/0-RTT/JSimages/blob/main/README](https://github.com/0-RTT/JSimages/blob/main/README)|

|   |   |   |
|---|---|---|
|![Lunrry](https://cdn.v2ex.com/avatar/f625/5dae/635681_normal.png?m=1730706709)||6<br><br>**[Lunrry](/member/Lunrry)** Â <br><br>Â  Â 51 å¤©å‰<br><br>@[740moe](/member/740moe) #5 ç°åœ¨å¯ä»¥ä½¿ç”¨äº†ï¼Œè¯·é—®æœ‰å°†å…¶æ¥å…¥åˆ° picgo çš„æ–¹æ¡ˆå—|

|   |   |   |
|---|---|---|
|![liulicaixiao](https://cdn.v2ex.com/avatar/8818/6464/599423_normal.png?m=1732329733)||7<br><br>**[liulicaixiao](/member/liulicaixiao)** Â <br><br>Â  Â 50 å¤©å‰<br><br>op çš„åŸŸåï¼š [https://baipiao.de/](https://baipiao.de/) éå¸¸å¥½|

|   |   |   |
|---|---|---|
|![740moe](https://cdn.v2ex.com/gravatar/87debd9e71f45569cc3a756c22be6dc2?s=48&d=retro)||8<br><br>**[740moe](/member/740moe)** Â <br><br>OP<br><br>Â  Â 50 å¤©å‰<br><br>@[Lunrry](/member/Lunrry) ç›®å‰æ²¡æœ‰ï¼Œè®© gpt å¸®ä½ è¯•è¯•ã€‚æˆ‘æ²¡ç”¨è¿‡ picgo|

|   |   |   |
|---|---|---|
|![740moe](https://cdn.v2ex.com/gravatar/87debd9e71f45569cc3a756c22be6dc2?s=48&d=retro)||9<br><br>**[740moe](/member/740moe)** Â <br><br>OP<br><br>Â  Â 50 å¤©å‰<br><br>@[liulicaixiao](/member/liulicaixiao) å˜¿å˜¿ğŸ‘|
